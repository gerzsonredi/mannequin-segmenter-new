name: Deploy to GCP Cloud Run

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: mannequin-segmenter
  REGION: europe-west4
  GAR_LOCATION: europe-west4-docker.pkg.dev
  REPOSITORY: mannequin-segmenter-repo

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Configure Docker to use gcloud as a credential helper
      run: |
        gcloud auth configure-docker ${{ env.GAR_LOCATION }}

    - name: Build GPU-optimized Docker image
      run: |
        docker build -f Dockerfile.gpu -t ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }} .
        docker build -f Dockerfile.gpu -t ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:latest .

    - name: Push Docker image to Artifact Registry
      run: |
        docker push ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
        docker push ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:latest

    - name: Deploy to Cloud Run with GPU
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --port 5001 \
          --memory 32Gi \
          --cpu 8 \
          --gpu 1 \
          --gpu-type nvidia-l4 \
          --timeout 900 \
          --concurrency 100 \
          --min-instances 1 \
          --max-instances 3 \
          --no-cpu-boost \
          --execution-environment gen2 \
          --set-env-vars="FLASK_ENV=production" \
          --set-env-vars="PYTHONPATH=/app" \
          --set-env-vars="CUDA_VISIBLE_DEVICES=0" \
          --set-secrets="AWS_ACCESS_KEY_ID=aws-access-key:latest" \
          --set-secrets="AWS_SECRET_ACCESS_KEY=aws-secret-key:latest" \
          --set-secrets="AWS_S3_BUCKET_NAME=aws-s3-bucket:latest" \
          --set-secrets="AWS_S3_REGION=aws-s3-region:latest"

    - name: Set public access
      run: |
        gcloud run services add-iam-policy-binding ${{ env.SERVICE_NAME }} \
          --region=${{ env.REGION }} \
          --member="allUsers" \
          --role="roles/run.invoker" || echo "Public access may be restricted by organization policy"

    - name: Get Cloud Run URL
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --platform managed --region ${{ env.REGION }} --format 'value(status.url)')
        echo "ðŸš€ Service deployed to: $SERVICE_URL"
        echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV

    - name: Verify deployment
      run: |
        echo "ðŸ§ª Verifying service is running..."
        gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format="value(status.conditions[0].status)"
        echo "âœ… Service verification completed!"

    - name: Deployment Summary
      run: |
        echo "## ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "- **Service**: ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: ${{ env.SERVICE_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Region**: ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Auto-scaling**: 1-3 instances (100 concurrent per instance, GPU quota limited)" >> $GITHUB_STEP_SUMMARY
        echo "- **Memory**: 32Gi" >> $GITHUB_STEP_SUMMARY
        echo "- **CPU**: 8" >> $GITHUB_STEP_SUMMARY
        echo "- **GPU**: 1x NVIDIA L4" >> $GITHUB_STEP_SUMMARY 
